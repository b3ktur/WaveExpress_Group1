{% extends 'base.html' %}
{% load humanize %}
{% load reservation_extras %}

{% block title %}My Reservations - WaveExpress{% endblock %}

{% block extra_css %}
<style>
    .countdown-warning {
        color: #dc3545;
        font-weight: bold;
    }
    .time-expired {
        color: #721c24;
        background-color: #f8d7da;
        padding: 2px 5px;
        border-radius: 3px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h1 class="mb-4">My Reservations</h1>
    
    {% if reservation_expiry %}
    <div class="alert alert-warning">
        <div class="d-flex align-items-center">
            <div class="flex-shrink-0 me-3">
                <i class="bi bi-clock-history" style="font-size: 2.5rem;"></i>
            </div>
            <div class="flex-grow-1">
                <h5><strong>Pending Reservation Payment Deadline</strong></h5>
                <p class="mb-0">You have pending reservations that require payment. Reservations will be automatically cancelled if payment is not received within 24 hours of booking.</p>
                <div class="mt-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="fw-bold">Time Remaining:</span>
                        <span id="countdown" class="badge bg-danger p-2" data-expiry="{{ reservation_expiry|date:'Y-m-d H:i:s' }}">Loading countdown...</span>
                    </div>
                    <div class="progress mt-2" style="height: 10px;">
                        <div id="countdown-progress" class="progress-bar progress-bar-striped progress-bar-animated bg-danger" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    {% if reservations %}
        <ul class="nav nav-tabs mb-4" id="reservationTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="all-tab" data-bs-toggle="tab" data-bs-target="#all-reservations" 
                        type="button" role="tab" aria-controls="all-reservations" aria-selected="true">
                    All Reservations
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending-reservations" 
                        type="button" role="tab" aria-controls="pending-reservations" aria-selected="false">
                    Pending Reservations
                    <span class="badge bg-warning ms-2 pending-count">0</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="confirmed-tab" data-bs-toggle="tab" data-bs-target="#confirmed-reservations" 
                        type="button" role="tab" aria-controls="confirmed-reservations" aria-selected="false">
                    Confirmed Reservations
                </button>
            </li>
        </ul>
        
        <div class="tab-content" id="reservationTabsContent">
            <!-- All Reservations Tab -->
            <div class="tab-pane fade show active" id="all-reservations" role="tabpanel" aria-labelledby="all-tab">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Reservation #</th>
                                <th>Route</th>
                                <th>Departure</th>
                                <th>Status</th>
                                <th>Date Reserved</th>
                                <th>Payment Deadline</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for reservation in reservations %}
                            <tr>
                                <td>{{ reservation.reservation_id }}</td>
                                <td>{{ reservation.schedule.route.route_name }}</td>
                                <td>
                                    <strong>{{ reservation.schedule.departure_time|date:"D, M d, Y" }}</strong><br>
                                    {{ reservation.schedule.departure_time|time:"h:i A" }}<br>
                                    <small>{{ reservation.schedule.route.departure_port.port_name }}</small>
                                </td>
                                <td>
                                    <span class="badge {% if reservation.status == 'CONFIRMED' %}bg-success{% elif reservation.status == 'PENDING' %}bg-warning{% elif reservation.status == 'COMPLETED' %}bg-info{% else %}bg-danger{% endif %}">
                                        {{ reservation.status }}
                                    </span>
                                </td>
                                <td>{{ reservation.date_of_reservation|date:"M d, Y" }}</td>
                                <td>
                                    {% if reservation.status == 'PENDING' %}
                                        <span class="reservation-deadline" data-deadline="{{ reservation.date_of_reservation|date:'Y-m-d H:i:s' }}">
                                            {{ reservation.date_of_reservation|time_since }} remaining
                                        </span>
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group-vertical" role="group">
                                        <a href="{% url 'ferry_system:reservation_detail' reservation.reservation_id %}" class="btn btn-primary btn-sm">
                                            View Details
                                        </a>
                                        
                                        {% if reservation.status == 'CONFIRMED' and reservation.schedule.departure_time > now %}
                                            <a href="{% url 'ferry_system:convert_to_ticket' reservation.reservation_id %}" class="btn btn-success btn-sm">
                                                Convert to Ticket
                                            </a>
                                            
                                            {# Check if reservation can be cancelled (at least 2 days before departure) #}
                                            {% with time_until=reservation.schedule.departure_time|timeuntil:now %}
                                                {% if "days" in time_until and time_until|split:" "|get_item:0 >= "2" %}
                                                    <a href="{% url 'ferry_system:cancel_reservation' reservation.reservation_id %}" class="btn btn-danger btn-sm">
                                                        Cancel
                                                    </a>
                                                {% endif %}
                                            {% endwith %}
                                        {% elif reservation.status == 'PENDING' %}
                                            <a href="{% url 'ferry_system:pay_reservation' reservation.reservation_id %}" class="btn btn-warning btn-sm">
                                                Pay Deposit
                                            </a>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Pending Reservations Tab -->
            <div class="tab-pane fade" id="pending-reservations" role="tabpanel" aria-labelledby="pending-tab">
                <div class="alert alert-info">
                    <h5><i class="bi bi-info-circle-fill me-2"></i>About Pending Reservations</h5>
                    <p>Pending reservations need to be paid within 24 hours or they will be automatically cancelled.</p>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Reservation #</th>
                                <th>Route</th>
                                <th>Departure</th>
                                <th>Date Reserved</th>
                                <th>Time Remaining</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for reservation in reservations %}
                                {% if reservation.status == 'PENDING' %}
                                <tr class="pending-reservation">
                                    <td>{{ reservation.reservation_id }}</td>
                                    <td>{{ reservation.schedule.route.route_name }}</td>
                                    <td>
                                        <strong>{{ reservation.schedule.departure_time|date:"D, M d, Y" }}</strong><br>
                                        {{ reservation.schedule.departure_time|time:"h:i A" }}<br>
                                        <small>{{ reservation.schedule.route.departure_port.port_name }}</small>
                                    </td>
                                    <td>{{ reservation.date_of_reservation|date:"M d, Y H:i" }}</td>
                                    <td>
                                        <span class="deadline-countdown" data-created="{{ reservation.date_of_reservation|date:'Y-m-d H:i:s' }}">
                                            Calculating...
                                        </span>
                                    </td>
                                    <td>
                                        <a href="{% url 'ferry_system:pay_reservation' reservation.reservation_id %}" class="btn btn-warning btn-sm">
                                            Pay Now
                                        </a>
                                        <a href="{% url 'ferry_system:reservation_detail' reservation.reservation_id %}" class="btn btn-primary btn-sm mt-1">
                                            View Details
                                        </a>
                                    </td>
                                </tr>
                                {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Confirmed Reservations Tab -->
            <div class="tab-pane fade" id="confirmed-reservations" role="tabpanel" aria-labelledby="confirmed-tab">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Reservation #</th>
                                <th>Route</th>
                                <th>Departure</th>
                                <th>Date Reserved</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for reservation in reservations %}
                                {% if reservation.status == 'CONFIRMED' %}
                                <tr>
                                    <td>{{ reservation.reservation_id }}</td>
                                    <td>{{ reservation.schedule.route.route_name }}</td>
                                    <td>
                                        <strong>{{ reservation.schedule.departure_time|date:"D, M d, Y" }}</strong><br>
                                        {{ reservation.schedule.departure_time|time:"h:i A" }}<br>
                                        <small>{{ reservation.schedule.route.departure_port.port_name }}</small>
                                    </td>
                                    <td>{{ reservation.date_of_reservation|date:"M d, Y" }}</td>
                                    <td>
                                        <a href="{% url 'ferry_system:convert_to_ticket' reservation.reservation_id %}" class="btn btn-success btn-sm">
                                            Convert to Ticket
                                        </a>
                                        <a href="{% url 'ferry_system:reservation_detail' reservation.reservation_id %}" class="btn btn-primary btn-sm mt-1">
                                            View Details
                                        </a>
                                    </td>
                                </tr>
                                {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    {% else %}
        <div class="alert alert-info">
            <h4 class="alert-heading">No Reservations Found</h4>
            <p>You don't have any reservations yet. Why not check out the available schedules?</p>
            <hr>
            <a href="{% url 'ferry_system:schedule_list' %}" class="btn btn-primary">Browse Schedules</a>
        </div>
    {% endif %}
    
    <div class="mt-4">
        <a href="{% url 'ferry_system:schedule_list' %}" class="btn btn-primary">
            <i class="bi bi-calendar"></i> Browse Schedules
        </a>
        <a href="{% url 'home' %}" class="btn btn-secondary">
            <i class="bi bi-house"></i> Back to Home
        </a>
    </div>
</div>

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var countdownElement = document.getElementById('countdown');
        var progressBar = document.getElementById('countdown-progress');
        
        if (countdownElement) {
            var expiryStr = countdownElement.getAttribute('data-expiry');
            var expiryDate = new Date(expiryStr);
            
            // Get the original total duration (24 hours in milliseconds)
            var totalDuration = 24 * 60 * 60 * 1000; // 24 hours in milliseconds
            
            function updateCountdown() {
                var now = new Date();
                var diff = expiryDate - now;
                
                if (diff <= 0) {
                    countdownElement.innerHTML = '<i class="bi bi-x-circle me-1"></i> Expired';
                    countdownElement.classList.remove('bg-danger', 'bg-warning', 'bg-success');
                    countdownElement.classList.add('bg-secondary');
                    progressBar.style.width = '0%';
                    return;
                }
                
                // Calculate hours, minutes, seconds
                var hours = Math.floor(diff / (1000 * 60 * 60));
                var minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                var seconds = Math.floor((diff % (1000 * 60)) / 1000);
                
                // Format the time with leading zeros
                var formattedHours = hours < 10 ? '0' + hours : hours;
                var formattedMinutes = minutes < 10 ? '0' + minutes : minutes;
                var formattedSeconds = seconds < 10 ? '0' + seconds : seconds;
                
                // Update the countdown text
                countdownElement.innerHTML = 
                    '<i class="bi bi-clock-history me-1"></i> ' + 
                    formattedHours + ':' + formattedMinutes + ':' + formattedSeconds;
                
                // Update progress bar
                var percentRemaining = (diff / totalDuration) * 100;
                progressBar.style.width = percentRemaining + '%';
                
                // Change colors based on time remaining
                if (hours < 1) {
                    countdownElement.classList.remove('bg-warning', 'bg-success', 'bg-secondary');
                    countdownElement.classList.add('bg-danger');
                    progressBar.classList.remove('bg-warning', 'bg-success');
                    progressBar.classList.add('bg-danger');
                } else if (hours < 6) {
                    countdownElement.classList.remove('bg-danger', 'bg-success', 'bg-secondary');
                    countdownElement.classList.add('bg-warning');
                    progressBar.classList.remove('bg-danger', 'bg-success');
                    progressBar.classList.add('bg-warning');
                } else {
                    countdownElement.classList.remove('bg-danger', 'bg-warning', 'bg-secondary');
                    countdownElement.classList.add('bg-success');
                    progressBar.classList.remove('bg-danger', 'bg-warning');
                    progressBar.classList.add('bg-success');
                }
            }
            
            // Update immediately and then every second
            updateCountdown();
            setInterval(updateCountdown, 1000);
        }
        
        // Individual countdown timers for each pending reservation
        const deadlineElements = document.querySelectorAll('.deadline-countdown');
        deadlineElements.forEach(element => {
            const createdDate = new Date(element.dataset.created);
            const deadlineDate = new Date(createdDate.getTime() + (24 * 60 * 60 * 1000)); // 24 hours after creation
            
            function updateDeadline() {
                const now = new Date();
                const diffInSeconds = Math.floor((deadlineDate - now) / 1000);
                
                if (diffInSeconds <= 0) {
                    element.innerHTML = '<span class="time-expired">EXPIRED</span>';
                    element.classList.add('time-expired');
                    return;
                }
                
                const hours = Math.floor(diffInSeconds / 3600);
                const minutes = Math.floor((diffInSeconds % 3600) / 60);
                
                let deadlineText = '';
                if (hours > 0) {
                    deadlineText += `${hours}h `;
                }
                deadlineText += `${minutes}m remaining`;
                
                // Add warning class when less than 3 hours remain
                if (diffInSeconds < 10800) { // 3 hours in seconds
                    element.classList.add('countdown-warning');
                }
                
                element.textContent = deadlineText;
            }
            
            // Update immediately and then every minute
            updateDeadline();
            setInterval(updateDeadline, 60000);
        });
    });
</script>
{% endblock %}
{% endblock %}
